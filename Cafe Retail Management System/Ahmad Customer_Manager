"""
Customer Manager
Handles all customer-related operations
Demonstrates: Encapsulation, Data Structure usage
"""

from typing import List, Optional
from models import Customer
from database import DatabaseConnection

class CustomerManager:
    """Manages customer operations"""
    
    def __init__(self):
        self.db = DatabaseConnection()
    
    def add_customer(self, name: str, email: str, phone: str, 
                    address: str, customer_type: str = "Regular") -> tuple[bool, str, Optional[Customer]]:
        """
        Add new customer
        Returns: (success, message, customer)
        """
        try:
            # Validation
            if not name or len(name.strip()) == 0:
                return False, "Customer name is required", None
            
            if customer_type not in Customer.DISCOUNT_RATES:
                return False, f"Invalid customer type: {customer_type}", None
            
            # Insert into database
            query = """
                INSERT INTO customers (name, email, phone, address, customer_type, loyalty_points)
                VALUES (%s, %s, %s, %s, %s, %s)
            """
            success = self.db.execute_query(query, (
                name.strip(), email, phone, address, customer_type, 0
            ))
            
            if success:
                customer_id = self.db.get_last_insert_id()
                customer = Customer(
                    customer_id=customer_id,
                    name=name.strip(),
                    email=email,
                    phone=phone,
                    address=address,
                    customer_type=customer_type,
                    loyalty_points=0
                )
                return True, "Customer added successfully!", customer
            else:
                return False, "Failed to add customer", None
                
        except Exception as e:
            return False, f"Error adding customer: {str(e)}", None
    
    def update_customer(self, customer_id: int, name: str, email: str, 
                       phone: str, address: str, customer_type: str) -> tuple[bool, str]:
        """Update customer information"""
        try:
            if not name or len(name.strip()) == 0:
                return False, "Customer name is required"
            
            if customer_type not in Customer.DISCOUNT_RATES:
                return False, f"Invalid customer type: {customer_type}"
            
            query = """
                UPDATE customers
                SET name = %s, email = %s, phone = %s, address = %s, customer_type = %s
                WHERE customer_id = %s
            """
            success = self.db.execute_query(query, (
                name.strip(), email, phone, address, customer_type, customer_id
            ))
            
            if success:
                return True, "Customer updated successfully!"
            else:
                return False, "Failed to update customer"
                
        except Exception as e:
            return False, f"Error updating customer: {str(e)}"
    
    def get_customer(self, customer_id: int) -> Optional[Customer]:
        """Get customer by ID"""
        try:
            query = """
                SELECT customer_id, name, email, phone, address, customer_type, loyalty_points
                FROM customers
                WHERE customer_id = %s
            """
            result = self.db.fetch_one(query, (customer_id,))
            
            if result:
                return Customer(
                    customer_id=result[0],
                    name=result[1],
                    email=result[2] or "",
                    phone=result[3] or "",
                    address=result[4] or "",
                    customer_type=result[5],
                    loyalty_points=result[6]
                )
            return None
            
        except Exception as e:
            print(f"Error getting customer: {e}")
            return None
    
    def search_customers(self, search_term: str = "") -> List[Customer]:
        """Search customers by name, email, or phone"""
        try:
            if search_term:
                query = """
                    SELECT customer_id, name, email, phone, address, customer_type, loyalty_points
                    FROM customers
                    WHERE name LIKE %s OR email LIKE %s OR phone LIKE %s
                    ORDER BY name
                """
                search_pattern = f"%{search_term}%"
                results = self.db.fetch_all(query, (search_pattern, search_pattern, search_pattern))
            else:
                query = """
                    SELECT customer_id, name, email, phone, address, customer_type, loyalty_points
                    FROM customers
                    ORDER BY name
                """
                results = self.db.fetch_all(query)
            
            customers = []
            for row in results:
                customers.append(Customer(
                    customer_id=row[0],
                    name=row[1],
                    email=row[2] or "",
                    phone=row[3] or "",
                    address=row[4] or "",
                    customer_type=row[5],
                    loyalty_points=row[6]
                ))
            
            return customers
            
        except Exception as e:
            print(f"Error searching customers: {e}")
            return []
    
    def update_loyalty_points(self, customer_id: int, points_to_add: int) -> bool:
        """Add loyalty points to customer"""
        try:
            # Get current customer
            customer = self.get_customer(customer_id)
            if not customer:
                return False
            
            # Calculate new points
            new_points = customer.loyalty_points + points_to_add
            
            # Determine new customer type
            new_type = customer.customer_type
            if new_points >= 100 and customer.customer_type != 'VIP':
                new_type = 'VIP'
            
            # Update database
            query = """
                UPDATE customers
                SET loyalty_points = %s, customer_type = %s
                WHERE customer_id = %s
            """
            return self.db.execute_query(query, (new_points, new_type, customer_id))
            
        except Exception as e:
            print(f"Error updating loyalty points: {e}")
            return False
    
    def get_customer_transaction_history(self, customer_id: int) -> List[dict]:
        """Get customer's transaction history"""
        try:
            query = """
                SELECT t.transaction_id, t.transaction_date, t.total_amount, 
                       t.payment_method, u.name as staff_name
                FROM transactions t
                JOIN users u ON t.user_id = u.user_id
                WHERE t.customer_id = %s
                ORDER BY t.transaction_date DESC
            """
            results = self.db.fetch_all(query, (customer_id,))
            
            history = []
            for row in results:
                history.append({
                    'transaction_id': row[0],
                    'date': row[1].strftime('%Y-%m-%d %H:%M:%S'),
                    'amount': float(row[2]),
                    'payment_method': row[3],
                    'staff_name': row[4]
                })
            
            return history
            
        except Exception as e:
            print(f"Error getting transaction history: {e}")
            return []
    
    def get_customer_types(self) -> List[str]:
        """Get list of customer types"""
        return list(Customer.DISCOUNT_RATES.keys())
